# Chronos-2 Automatic Forecast Submission
#
# This workflow generates Chronos-2 forecasts and submits them to the RespiCast hub.
# The workflow runs every Wednesday at 15:30 UTC (after data is typically available)
# and creates a PR to the main hub repository.

name: Chronos-2 AutoSubmit

on:
  schedule:
    # Run every Wednesday at 15:30 UTC
    - cron: "30 15 * * 3"

  # Allow manual trigger for testing
  workflow_dispatch:

env:
  # Update this with your GitHub username
  GITHUB_USERNAME: abdulfatir

jobs:
  generate-and-submit:
    runs-on: ubuntu-latest

    steps:
      # Checkout forked repository
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.CHRONOS2_AUTOSUBMIT }}

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Install dependencies
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install 'chronos-forecasting[extras]' -f https://download.pytorch.org/whl/cpu/torch_stable.html

      # Save fork-specific files before switching to upstream
      - name: Save fork files
        run: |
          cp generate_chronos_forecast.py /tmp/generate_chronos_forecast.py

      # Configure git to pull from upstream hub
      - name: Configure git
        run: |
          git config --global user.name "Abdul Fatir"
          git config --global user.email "abdulfatirs@gmail.com"
          git remote add upstream https://github.com/european-modelling-hubs/RespiCast-SyndromicIndicators.git
          git fetch upstream
          git checkout -B pr-chronos2 upstream/main

      # Restore fork-specific files
      - name: Restore fork files
        run: |
          cp /tmp/generate_chronos_forecast.py generate_chronos_forecast.py

      # Set default repo for gh CLI
      - name: Set default repo
        run: gh repo set-default european-modelling-hubs/RespiCast-SyndromicIndicators
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Get the origin date (latest Wednesday from forecasting_weeks.csv)
      - name: Get origin date
        id: date
        run: |
          origin_date=$(python -c "import pandas as pd; print(sorted(pd.read_csv('supporting-files/forecasting_weeks.csv')['origin_date'].unique())[-1])")
          echo "origin_date=$origin_date" >> $GITHUB_OUTPUT
          echo "Origin date: $origin_date"

      # Generate Chronos-2 forecast
      - name: Generate forecast
        run: |
          echo "Generating Chronos-2 forecast for ${{ steps.date.outputs.origin_date }}"
          python generate_chronos_forecast.py
          echo "Forecast generated successfully"
          ls -la model-output/Chronos-Chronos2/

      # Commit and push
      - name: Commit forecast
        run: |
          git add model-output/Chronos-Chronos2/
          git commit -m "Add Chronos-2 forecast for ${{ steps.date.outputs.origin_date }}"
          git push -f origin pr-chronos2

      # Create pull request to upstream
      - name: Create pull request
        run: |
          # Check if PR already exists
          existing_pr=$(gh pr list --head "${{ env.GITHUB_USERNAME }}:pr-chronos2" --json number --jq '.[0].number' || echo "")

          if [ -n "$existing_pr" ]; then
            echo "PR #$existing_pr already exists, updating..."
          else
            echo "Creating new PR..."
            gh pr create \
              --head "${{ env.GITHUB_USERNAME }}:pr-chronos2" \
              --base main \
              --title "Chronos-2 forecast: ${{ steps.date.outputs.origin_date }}" \
              --body "Forecast for origin_date ${{ steps.date.outputs.origin_date }}, generated by the [Chronos-2 model](https://github.com/amazon-science/chronos-forecasting)"
          fi
        env:
          GH_TOKEN: ${{ secrets.CHRONOS2_AUTOSUBMIT }}

      # Summary
      - name: Summary
        run: |
          echo "## Chronos-2 Forecast Submission" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Origin date:** ${{ steps.date.outputs.origin_date }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files generated:**" >> $GITHUB_STEP_SUMMARY
          ls model-output/Chronos-Chronos2/*.csv >> $GITHUB_STEP_SUMMARY
